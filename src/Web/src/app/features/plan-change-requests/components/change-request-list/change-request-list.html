<mat-card>
    <mat-card-header>
        <mat-card-title>Plan Change Requests</mat-card-title>
    </mat-card-header>

    <mat-card-content>
        @if (loading()) {
        <div class="loading-container">
            <mat-spinner></mat-spinner>
        </div>
        } @else {
        <mat-tab-group>
            <!-- Pending Requests Tab -->
            <mat-tab label="Pending ({{ pendingRequests().length }})">
                <div class="tab-content">
                    @if (pendingRequests().length > 0) {
                    <table mat-table [dataSource]="pendingRequests()" class="requests-table">
                        <ng-container matColumnDef="contractNumber">
                            <th mat-header-cell *matHeaderCellDef>Contract #</th>
                            <td mat-cell *matCellDef="let request">{{ request.contractNumber }}</td>
                        </ng-container>

                        <ng-container matColumnDef="fromPlan">
                            <th mat-header-cell *matHeaderCellDef>From Plan</th>
                            <td mat-cell *matCellDef="let request">{{ request.fromPlanName }}</td>
                        </ng-container>

                        <ng-container matColumnDef="toPlan">
                            <th mat-header-cell *matHeaderCellDef>To Plan</th>
                            <td mat-cell *matCellDef="let request">
                                <div class="plan-change">
                                    {{ request.toPlanName }}
                                    @if (request.isUpgrade) {
                                    <mat-icon class="upgrade-icon" matTooltip="Upgrade">trending_up</mat-icon>
                                    } @else {
                                    <mat-icon class="downgrade-icon" matTooltip="Downgrade">trending_down</mat-icon>
                                    }
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="requestedBy">
                            <th mat-header-cell *matHeaderCellDef>Requested By</th>
                            <td mat-cell *matCellDef="let request">{{ request.requestedBy }}</td>
                        </ng-container>

                        <ng-container matColumnDef="requestedAt">
                            <th mat-header-cell *matHeaderCellDef>Requested At</th>
                            <td mat-cell *matCellDef="let request">{{ request.requestedAt | date:'short' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Status</th>
                            <td mat-cell *matCellDef="let request">
                                <mat-chip [color]="getStatusColor(request.status)" highlighted>
                                    {{ request.status }}
                                </mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let request">
                                <button mat-icon-button (click)="processRequest(request)" matTooltip="Process">
                                    <mat-icon>check_circle</mat-icon>
                                </button>
                                <button mat-icon-button (click)="cancelRequest(request, $event)" matTooltip="Cancel"
                                    color="warn">
                                    <mat-icon>cancel</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                    } @else {
                    <div class="no-data">
                        <mat-icon>inbox</mat-icon>
                        <p>No pending requests</p>
                    </div>
                    }
                </div>
            </mat-tab>

            <!-- All Requests Tab -->
            <mat-tab label="All Requests ({{ allRequests().length }})">
                <div class="tab-content">
                    @if (allRequests().length > 0) {
                    <table mat-table [dataSource]="allRequests()" class="requests-table">
                        <ng-container matColumnDef="contractNumber">
                            <th mat-header-cell *matHeaderCellDef>Contract #</th>
                            <td mat-cell *matCellDef="let request">{{ request.contractNumber }}</td>
                        </ng-container>

                        <ng-container matColumnDef="fromPlan">
                            <th mat-header-cell *matHeaderCellDef>From Plan</th>
                            <td mat-cell *matCellDef="let request">{{ request.fromPlanName }}</td>
                        </ng-container>

                        <ng-container matColumnDef="toPlan">
                            <th mat-header-cell *matHeaderCellDef>To Plan</th>
                            <td mat-cell *matCellDef="let request">
                                <div class="plan-change">
                                    {{ request.toPlanName }}
                                    @if (request.isUpgrade) {
                                    <mat-icon class="upgrade-icon">trending_up</mat-icon>
                                    } @else {
                                    <mat-icon class="downgrade-icon">trending_down</mat-icon>
                                    }
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="requestedBy">
                            <th mat-header-cell *matHeaderCellDef>Requested By</th>
                            <td mat-cell *matCellDef="let request">{{ request.requestedBy }}</td>
                        </ng-container>

                        <ng-container matColumnDef="requestedAt">
                            <th mat-header-cell *matHeaderCellDef>Requested At</th>
                            <td mat-cell *matCellDef="let request">{{ request.requestedAt | date:'short' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Status</th>
                            <td mat-cell *matCellDef="let request">
                                <mat-chip [color]="getStatusColor(request.status)" highlighted>
                                    {{ request.status }}
                                </mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let request">
                                @if (request.status === 'Pending') {
                                <button mat-icon-button (click)="processRequest(request)" matTooltip="Process">
                                    <mat-icon>check_circle</mat-icon>
                                </button>
                                }
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                    } @else {
                    <div class="no-data">
                        <mat-icon>inbox</mat-icon>
                        <p>No change requests found</p>
                    </div>
                    }
                </div>
            </mat-tab>
        </mat-tab-group>
        }
    </mat-card-content>
</mat-card>